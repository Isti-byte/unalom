<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pong Game</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="screen active">
    <div class="menu-container">
      <h1>PONG ARENA</h1>
      <div class="login-container">
        <div class="login-form">
          <h2>Login</h2>
          <input type="text" id="usernameInput" placeholder="Enter username" class="login-input">
          <input type="password" id="passwordInput" placeholder="Enter password" class="login-input">
          <button class="btn" onclick="loginUser()">LOGIN</button>
          <p class="login-text">Don't have an account? <span class="link" onclick="switchToRegister()">Register</span>
          </p>
          <p id="loginError" class="error-message"></p>
        </div>
        <div class="login-form" id="registerForm" style="display: none;">
          <h2>Register</h2>
          <input type="text" id="regUsernameInput" placeholder="Choose username" class="login-input">
          <input type="password" id="regPasswordInput" placeholder="Choose password" class="login-input">
          <input type="password" id="regPasswordConfirm" placeholder="Confirm password" class="login-input">
          <button class="btn" onclick="registerUser()">REGISTER</button>
          <p class="login-text">Already have an account? <span class="link" onclick="switchToLogin()">Login</span></p>
          <p id="registerError" class="error-message"></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Menu -->
  <div id="menuScreen" class="screen">
    <div class="menu-container">
      <h1 id="titleClick" onclick="titleClicked()" style="cursor: pointer;">PONG</h1>
      <div class="menu-buttons">
        <button class="btn" onclick="startGame(1)">1 PLAYER</button>
        <button class="btn" onclick="startGame(2)">2 PLAYERS</button>
        <button class="btn" onclick="viewRanklist()">RANKLIST</button>
        <button class="btn" onclick="viewProfile()" style="background-color: #4a9eff;">MY PROFILE</button>
        <button class="btn" onclick="enterCustomization()" style="background-color: #aa00ff;">‚öôÔ∏è CUSTOMIZE</button>
        <button class="btn" onclick="logoutUser()" style="background-color: #ff6b6b;">LOGOUT</button>
        <button class="btn" onclick="enterTestMode()" id="ownerBtn" style="display: none; background-color: #ffaa00;">üëë
          OWNER MODE</button>
      </div>
    </div>
  </div>

  <!-- Ranklist Screen -->
  <div id="ranklistScreen" class="screen">
    <div class="menu-container">
      <h1>GLOBAL RANKLIST</h1>
      <div class="ranklist-container">
        <table class="ranklist-table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Username</th>
              <th>Wins</th>
              <th>Losses</th>
              <th>Win Rate</th>
            </tr>
          </thead>
          <tbody id="ranklistBody">
          </tbody>
        </table>
      </div>
      <div class="menu-buttons">
        <button class="btn" onclick="goToMenu()">BACK</button>
      </div>
    </div>
  </div>

  <!-- Game Mode Selection Screen -->
  <div id="gameModeScreen" class="screen">
    <div class="menu-container">
      <h1>SELECT GAME MODE</h1>
      <div class="menu-buttons">
        <button class="btn" onclick="selectGameMode('classic')">CLASSIC</button>
        <button class="btn" onclick="selectGameMode('timeattack')">TIME ATTACK (2 MIN)</button>
        <button class="btn" onclick="selectGameMode('survival')">SURVIVAL MODE</button>
        <button class="btn" onclick="selectGameMode('powerups')">POWER-UPS MODE</button>
        <button class="btn" onclick="goToMenu()">BACK</button>
      </div>
    </div>
  </div>

  <!-- Difficulty Selection Screen -->
  <div id="difficultyScreen" class="screen">
    <div class="menu-container">
      <h1>SELECT DIFFICULTY</h1>
      <div class="menu-buttons">
        <button class="btn" onclick="startGameWithDifficulty('easy')">EASY</button>
        <button class="btn" onclick="startGameWithDifficulty('medium')">MEDIUM</button>
        <button class="btn" onclick="startGameWithDifficulty('hard')">HARD</button>
        <button class="btn" onclick="goToMenu()">BACK</button>
      </div>
    </div>
  </div>

  <!-- Customization Screen -->
  <div id="customizationScreen" class="screen">
    <div class="menu-container">
      <h1>CUSTOMIZE</h1>
      <div class="customization-container">
        <div class="custom-section">
          <h3>Game Theme</h3>
          <div class="custom-buttons">
            <button class="custom-btn" onclick="setTheme('dark')" id="themeBtn-dark">üåë DARK</button>
            <button class="custom-btn" onclick="setTheme('neon')" id="themeBtn-neon">‚ö° NEON</button>
            <button class="custom-btn" onclick="setTheme('retro')" id="themeBtn-retro">üïπÔ∏è RETRO</button>
          </div>
        </div>

        <div class="custom-section">
          <h3>Paddle Color</h3>
          <div class="custom-buttons">
            <button class="custom-btn" onclick="setPaddleColor('#ffffff')" style="background-color: #ffffff; color: #000;">WHITE</button>
            <button class="custom-btn" onclick="setPaddleColor('#00ff00')" style="background-color: #00ff00; color: #000;">GREEN</button>
            <button class="custom-btn" onclick="setPaddleColor('#ff0080')" style="background-color: #ff0080;">PINK</button>
            <button class="custom-btn" onclick="setPaddleColor('#00ccff')" style="background-color: #00ccff; color: #000;">CYAN</button>
          </div>
        </div>

        <div class="custom-section">
          <h3>Ball Style</h3>
          <div class="custom-buttons">
            <button class="custom-btn" onclick="setBallStyle('default')">‚óèCIRCLE</button>
            <button class="custom-btn" onclick="setBallStyle('glow')">‚ú®GLOW</button>
            <button class="custom-btn" onclick="setBallStyle('trail')">‚û§ TRAIL</button>
            <button class="custom-btn" onclick="setBallStyle('square')">‚ñ†SQUARE</button>
          </div>
        </div>

        <div class="custom-section">
          <h3>Sound Effects</h3>
          <div class="custom-buttons">
            <button class="custom-btn" id="soundBtn" onclick="toggleSound()">üîä SOUND ON</button>
          </div>
        </div>
      </div>
      <div class="menu-buttons">
        <button class="btn" onclick="goToMenu()">BACK</button>
      </div>
    </div>
  </div>

  <!-- Player Profile Screen -->
  <div id="profileScreen" class="screen">
    <div class="menu-container">
      <h1>PLAYER PROFILE</h1>
      <div class="profile-container">
        <div class="profile-info">
          <h2 id="profileUsername">Player Name</h2>
          <div class="profile-stats">
            <p><strong>Total Wins:</strong> <span id="profileWins">0</span></p>
            <p><strong>Total Losses:</strong> <span id="profileLosses">0</span></p>
            <p><strong>Win Rate:</strong> <span id="profileWinRate">0</span>%</p>
            <p><strong>Games Played:</strong> <span id="profileGames">0</span></p>
            <p><strong>Best Score:</strong> <span id="profileBest">0</span></p>
          </div>
        </div>
        <div class="match-history">
          <h3>Recent Matches</h3>
          <div id="matchHistoryList" class="history-list">
          </div>
        </div>
      </div>
      <div class="menu-buttons">
        <button class="btn" onclick="goToMenu()">BACK</button>
      </div>
    </div>
  </div>

  <!-- Test Mode Screen -->
  <div id="testScreen" class="screen">
    <div class="menu-container">
      <h1>TEST MODE</h1>
      <div class="test-container">
        <div class="test-section">
          <h3>Ball Speed Control</h3>
          <div class="test-controls">
            <label>Speed: <input type="range" id="ballSpeedSlider" min="1" max="10" value="3"
                onchange="testBallSpeed()"></label>
            <p id="ballSpeedDisplay">Current: 3</p>
          </div>
        </div>

        <div class="test-section">
          <h3>AI Difficulty</h3>
          <div class="test-controls">
            <button class="test-btn" onclick="testAIDifficulty('easy')">EASY</button>
            <button class="test-btn" onclick="testAIDifficulty('medium')">MEDIUM</button>
            <button class="test-btn" onclick="testAIDifficulty('hard')">HARD</button>
            <p id="aiDiffDisplay">Current: medium</p>
          </div>
        </div>

        <div class="test-section">
          <h3>Paddle Size</h3>
          <div class="test-controls">
            <label>Height: <input type="range" id="paddleSizeSlider" min="20" max="120" value="60"
                onchange="testPaddleSize()"></label>
            <p id="paddleSizeDisplay">Current: 60px</p>
          </div>
        </div>

        <div class="test-section">
          <h3>Canvas Size</h3>
          <div class="test-controls">
            <button class="test-btn" onclick="testCanvasSize(600, 300)">SMALL</button>
            <button class="test-btn" onclick="testCanvasSize(800, 400)">MEDIUM</button>
            <button class="test-btn" onclick="testCanvasSize(1000, 500)">LARGE</button>
            <p id="canvasSizeDisplay">Current: 800x400</p>
          </div>
        </div>

        <div class="test-section">
          <h3>Game Stats</h3>
          <div class="test-controls">
            <button class="test-btn" onclick="testResetScores()">RESET SCORES</button>
            <button class="test-btn" onclick="testSetScore()">SET CUSTOM SCORE</button>
            <p id="statsDisplay">P1: 0 | P2: 0</p>
          </div>
        </div>

        <div class="test-section">
          <h3>Start Game</h3>
          <div class="test-controls">
            <button class="test-btn" onclick="startTestGame(1)">PLAY vs AI</button>
            <button class="test-btn" onclick="startTestGame(2)">PLAY LOCAL 2P</button>
          </div>
        </div>
      </div>
      <div class="menu-buttons">
        <button class="btn" onclick="goToMenu()">EXIT TEST MODE</button>
      </div>
    </div>
  </div>

  <!-- Winner/Loser Screen -->
  <div id="resultScreen" class="screen">
    <div class="menu-container">
      <h1 id="resultTitle">VICTORY!</h1>
      <div class="result-container">
        <p id="resultMessage" class="result-message"></p>
        <p id="resultStats" class="result-stats"></p>
      </div>
      <div class="menu-buttons">
        <button class="btn" onclick="goToMenu()">BACK TO MENU</button>
        <button class="btn" onclick="playAgain()" style="background-color: #00aa00;">PLAY AGAIN</button>
      </div>
    </div>
  </div>

  <!-- Game Screen -->
  <div id="gameScreen" class="screen">
    <div class="game-wrapper">
      <div class="player-info left">
        <h3>Player 1</h3>
        <p class="score" id="score1">0</p>
        <p id="p1Streak" style="font-size: 12px; color: #ffaa00;">Streak: 0</p>
      </div>
      <div class="canvas-container">
        <canvas id="gameCanvas" width="800" height="400"></canvas>
        <div id="gameTimerDisplay" style="position: absolute; top: 10px; right: 10px; font-size: 24px; color: #fff; display: none;">
          <strong id="gameTimer">120s</strong>
        </div>
        <!-- Mobile touch controls -->
        <div class="mobile-controls" id="mobileControls" style="display:none;">
          <div class="touch-zone left-zone" id="leftUp" ontouchstart="handleMobileControl('p1Up', true)"
            ontouchend="handleMobileControl('p1Up', false)">‚Üë</div>
          <div class="touch-zone right-zone" id="rightUp" ontouchstart="handleMobileControl('p2Up', true)"
            ontouchend="handleMobileControl('p2Up', false)">‚Üë</div>
          <div class="touch-zone left-zone bottom" id="leftDown" ontouchstart="handleMobileControl('p1Down', true)"
            ontouchend="handleMobileControl('p1Down', false)">‚Üì</div>
          <div class="touch-zone right-zone bottom" id="rightDown" ontouchstart="handleMobileControl('p2Down', true)"
            ontouchend="handleMobileControl('p2Down', false)">‚Üì</div>
        </div>
      </div>
      <div class="player-info right">
        <h3>Player 2</h3>
        <p class="score" id="score2">0</p>
        <p id="p2Streak" style="font-size: 12px; color: #ffaa00;">Streak: 0</p>
      </div>
    </div>
    <div class="game-controls">
      <div class="controls-text">
        <p id="p1ControlText"><strong>Player 1:</strong> W / S keys</p>
        <p id="p2Text"><strong>Player 2:</strong> ‚Üë / ‚Üì keys</p>
      </div>
      <button class="btn" onclick="unstuckBall()" style="background-color: #ff9500;">UNSTUCK BALL</button>
      <button class="btn" onclick="pauseGame()">PAUSE</button>
      <button class="btn" onclick="goToMenu()">MENU</button>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // Game Variables
    let gameMode = 2; // 1 or 2 players
    let difficulty = 'medium'; // easy, medium, hard
    let gameType = 'classic'; // classic, timeattack, survival, powerups
    let isPaused = false;
    let gameRunning = true;
    let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    let lastGameMode = null;
    let lastDifficulty = null;
    let lastGameType = null;
    const WINNING_SCORE = 20;
    
    // Customization
    let currentTheme = 'dark';
    let paddleColor = '#ffffff';
    let ballStyle = 'default';
    let soundEnabled = true;
    let progressiveDifficulty = true;
    let ballRallies = 0;
    
    // Time Attack Mode
    let timeAttackSeconds = 120;
    let timeAttackInterval = null;
    
    // Survival Mode
    let survivalLives = 3;
    
    // Power-ups
    let powerUps = [];
    let activePowerUps = {
      player1: { speedBoost: 0, paddleSize: 0, slowMo: 0 },
      player2: { speedBoost: 0, paddleSize: 0, slowMo: 0 }
    };
    
    // Ball Trail
    let ballTrail = [];
    
    // Streak tracking
    let currentStreak = { player1: 0, player2: 0 };
    
    // User Authentication
    const OWNER_USERNAME = 'hajdui';
    let currentUser = null;
    let users = JSON.parse(localStorage.getItem('pongUsers')) || {};
    let userStats = JSON.parse(localStorage.getItem('pongStats')) || {};
    let matchHistory = JSON.parse(localStorage.getItem('pongHistory')) || {};
    let userSettings = JSON.parse(localStorage.getItem('pongSettings')) || {};

    // Test mode variables
    let testModeActive = false;
    let testMode_ballSpeed = 3;
    let testMode_playing = false;
    let titleClickCount = 0;
    let titleClickTimer = null;
    let mobileKeys = {
      p1Up: false,
      p1Down: false,
      p2Up: false,
      p2Down: false
    };

    // Load user settings
    function loadUserSettings() {
      if (!currentUser) return;
      if (!userSettings[currentUser]) {
        userSettings[currentUser] = {
          theme: 'dark',
          paddleColor: '#ffffff',
          ballStyle: 'default',
          soundEnabled: true
        };
      }
      const settings = userSettings[currentUser];
      currentTheme = settings.theme || 'dark';
      paddleColor = settings.paddleColor || '#ffffff';
      ballStyle = settings.ballStyle || 'default';
      soundEnabled = settings.soundEnabled !== false;
      applyTheme(currentTheme);
    }

    function saveUserSettings() {
      if (!currentUser) return;
      userSettings[currentUser] = {
        theme: currentTheme,
        paddleColor: paddleColor,
        ballStyle: ballStyle,
        soundEnabled: soundEnabled
      };
      localStorage.setItem('pongSettings', JSON.stringify(userSettings));
    }

    // Power-up Class
    class PowerUp {
      constructor(x, y, type) {
        this.x = x;
        this.y = y;
        this.radius = 8;
        this.type = type; // 'speedBoost', 'paddleSize', 'slowMo'
        this.collected = false;
      }

      draw() {
        ctx.fillStyle = this.type === 'speedBoost' ? '#ff6b00' : this.type === 'paddleSize' ? '#00ff00' : '#0099ff';
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 2;
        ctx.stroke();
      }

      checkCollision(paddle) {
        let dx = this.x - (paddle.x + paddle.width / 2);
        let dy = this.y - (paddle.y + paddle.height / 2);
        let distance = Math.sqrt(dx * dx + dy * dy);
        return distance < this.radius + 15;
      }
    }

    // Particle Class for effects
    class Particle {
      constructor(x, y, vx, vy, color) {
        this.x = x;
        this.y = y;
        this.vx = vx;
        this.vy = vy;
        this.color = color;
        this.life = 1;
      }

      update() {
        this.x += this.vx;
        this.y += this.vy;
        this.vy += 0.1; // gravity
        this.life -= 0.02;
      }

      draw() {
        ctx.globalAlpha = this.life;
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(this.x, this.y, 3, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1;
      }
    }

    let particles = [];

    // Paddle Class
    class Paddle {
      constructor(x, y) {
        this.x = x;
        this.y = y;
        this.width = 10;
        this.height = 60;
        this.speed = 4;
        this.dy = 0;
        this.score = 0;
        this.baseHeight = 60;
        this.baseSpeed = 4;
      }

      update() {
        this.y += this.dy;
        if (this.y < 0) this.y = 0;
        if (this.y + this.height > canvas.height) this.y = canvas.height - this.height;
      }

      draw() {
        ctx.fillStyle = paddleColor;
        ctx.fillRect(this.x, this.y, this.width, this.height);
        
        // Draw glow for neon theme
        if (currentTheme === 'neon') {
          ctx.shadowColor = paddleColor;
          ctx.shadowBlur = 15;
          ctx.strokeStyle = paddleColor;
          ctx.lineWidth = 2;
          ctx.strokeRect(this.x, this.y, this.width, this.height);
          ctx.shadowBlur = 0;
        }
      }

      reset() {
        this.y = canvas.height / 2 - this.height / 2;
        this.dy = 0;
      }
    }

    // Ball Class
    class Ball {
      constructor() {
        this.x = canvas.width / 2;
        this.y = canvas.height / 2;
        this.radius = 5;
        this.speedX = 3;
        this.speedY = 3;
        this.baseSpeedX = 3;
        this.baseSpeedY = 3;
      }

      update() {
        // Apply slow-mo if active
        let speedMultiplier = 1;
        if (activePowerUps.player1.slowMo > 0 || activePowerUps.player2.slowMo > 0) {
          speedMultiplier = 0.5;
        }

        this.x += this.speedX * speedMultiplier;
        this.y += this.speedY * speedMultiplier;

        // Record trail
        if (ballStyle === 'trail') {
          ballTrail.push({ x: this.x, y: this.y });
          if (ballTrail.length > 15) ballTrail.shift();
        }

        // Bounce off top and bottom
        if (this.y - this.radius < 0 || this.y + this.radius > canvas.height) {
          this.speedY = -this.speedY;
          playSound('bounce');
        }

        // Bounce off paddles
        this.checkPaddleCollision(player1);
        this.checkPaddleCollision(player2);

        // Score points
        if (this.x - this.radius < 0) {
          player2.score++;
          currentStreak.player2++;
          currentStreak.player1 = 0;
          playSound('score');
          this.reset();
          ballRallies = 0;
        } else if (this.x + this.radius > canvas.width) {
          player1.score++;
          currentStreak.player1++;
          currentStreak.player2 = 0;
          playSound('score');
          this.reset();
          ballRallies = 0;
        }

        updateScores();
      }

      checkPaddleCollision(paddle) {
        let ballLeft = this.x - this.radius;
        let ballRight = this.x + this.radius;
        let ballTop = this.y - this.radius;
        let ballBottom = this.y + this.radius;

        let paddleLeft = paddle.x;
        let paddleRight = paddle.x + paddle.width;
        let paddleTop = paddle.y;
        let paddleBottom = paddle.y + paddle.height;

        if (ballLeft < paddleRight && ballRight > paddleLeft &&
          ballTop < paddleBottom && ballBottom > paddleTop) {

          let overlapLeft = ballRight - paddleLeft;
          let overlapRight = paddleRight - ballLeft;
          let overlapTop = ballBottom - paddleTop;
          let overlapBottom = paddleBottom - ballTop;

          let minOverlap = Math.min(overlapLeft, overlapRight, overlapTop, overlapBottom);

          if (minOverlap === overlapLeft || minOverlap === overlapRight) {
            this.speedX = -this.speedX;
            this.speedY += paddle.dy * 0.15;
            ballRallies++;

            if (paddle === player1) {
              this.x = paddleRight + this.radius;
            } else {
              this.x = paddleLeft - this.radius;
            }
            playSound('paddle');
          } else {
            this.speedY = -this.speedY;
            this.speedX += paddle.dy * 0.15;

            if (minOverlap === overlapTop) {
              this.y = paddleTop - this.radius;
            } else {
              this.y = paddleBottom + this.radius;
            }
          }
        }
      }

      draw() {
        if (ballStyle === 'glow') {
          ctx.fillStyle = '#ffff00';
          ctx.shadowColor = '#ffff00';
          ctx.shadowBlur = 15;
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
          ctx.fill();
          ctx.shadowBlur = 0;
        } else if (ballStyle === 'square') {
          ctx.fillStyle = '#fff';
          ctx.fillRect(this.x - this.radius, this.y - this.radius, this.radius * 2, this.radius * 2);
        } else {
          ctx.fillStyle = '#fff';
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      reset() {
        this.x = canvas.width / 2;
        this.y = canvas.height / 2;
        this.speedX = (Math.random() > 0.5 ? 1 : -1) * 3;
        this.speedY = (Math.random() * 4 - 2);
        ballTrail = [];
      }
    }

    // Create game objects
    const player1 = new Paddle(10, canvas.height / 2 - 30);
    const player2 = new Paddle(canvas.width - 20, canvas.height / 2 - 30);
    const ball = new Ball();

    // Keyboard input
    const keys = {};
    document.addEventListener('keydown', (e) => {
      keys[e.key.toLowerCase()] = true;

      if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 't') {
        enterTestMode();
        return;
      }

      if (keys['w']) player1.dy = -player1.speed;
      if (keys['s']) player1.dy = player1.speed;
      if (keys['arrowup']) player2.dy = -player2.speed;
      if (keys['arrowdown']) player2.dy = player2.speed;
    });

    document.addEventListener('keyup', (e) => {
      keys[e.key.toLowerCase()] = false;
      if (!keys['w'] && !keys['s']) player1.dy = 0;
      if (!keys['arrowup'] && !keys['arrowdown']) player2.dy = 0;
    });

    // Mobile control handler
    function handleMobileControl(control, isPressed) {
      mobileKeys[control] = isPressed;

      if (mobileKeys.p1Up) player1.dy = -player1.speed;
      else if (mobileKeys.p1Down) player1.dy = player1.speed;
      else player1.dy = 0;

      if (mobileKeys.p2Up) player2.dy = -player2.speed;
      else if (mobileKeys.p2Down) player2.dy = player2.speed;
      else if (gameMode === 2) player2.dy = 0;
    }

    // AI for single player
    function updateAI() {
      const paddle = player2;
      const dy = ball.y - (paddle.y + paddle.height / 2);

      let speed = paddle.speed;
      let threshold = 35;

      if (difficulty === 'easy') {
        speed = 2;
        threshold = 60;
      } else if (difficulty === 'medium') {
        speed = 5;
        threshold = 35;
      } else if (difficulty === 'hard') {
        speed = 8;
        threshold = 15;
      }

      if (dy < -threshold) {
        paddle.dy = -speed;
      } else if (dy > threshold) {
        paddle.dy = speed;
      } else {
        paddle.dy = 0;
      }
    }

    // Power-up functions
    function spawnPowerUp() {
      if (gameType !== 'powerups' || Math.random() > 0.02) return; // 2% chance per frame
      
      const types = ['speedBoost', 'paddleSize', 'slowMo'];
      const randomType = types[Math.floor(Math.random() * types.length)];
      const x = Math.random() * (canvas.width - 40) + 20;
      const y = Math.random() * (canvas.height - 40) + 20;
      
      powerUps.push(new PowerUp(x, y, randomType));
    }

    function updatePowerUps() {
      for (let i = powerUps.length - 1; i >= 0; i--) {
        const pu = powerUps[i];
        pu.draw();

        if (pu.checkCollision(player1)) {
          applyPowerUp('player1', pu.type);
          powerUps.splice(i, 1);
        } else if (pu.checkCollision(player2)) {
          applyPowerUp('player2', pu.type);
          powerUps.splice(i, 1);
        }
      }
    }

    function applyPowerUp(player, type) {
      playSound('powerup');
      if (type === 'speedBoost') {
        activePowerUps[player].speedBoost = 300; // frames
        const paddle = player === 'player1' ? player1 : player2;
        paddle.speed = paddle.baseSpeed * 1.5;
      } else if (type === 'paddleSize') {
        activePowerUps[player].paddleSize = 300;
        const paddle = player === 'player1' ? player1 : player2;
        paddle.height = paddle.baseHeight * 1.5;
      } else if (type === 'slowMo') {
        activePowerUps[player].slowMo = 150;
      }
    }

    function updateActivePowerUps() {
      for (let player of ['player1', 'player2']) {
        const paddle = player === 'player1' ? player1 : player2;
        
        if (activePowerUps[player].speedBoost > 0) {
          activePowerUps[player].speedBoost--;
        } else {
          paddle.speed = paddle.baseSpeed;
        }

        if (activePowerUps[player].paddleSize > 0) {
          activePowerUps[player].paddleSize--;
        } else {
          paddle.height = paddle.baseHeight;
        }

        if (activePowerUps[player].slowMo > 0) {
          activePowerUps[player].slowMo--;
        }
      }
    }

    // Theme system
    function applyTheme(theme) {
      currentTheme = theme;
      const gameScreen = document.getElementById('gameCanvas').parentElement;
      
      if (theme === 'neon') {
        gameScreen.style.backgroundColor = '#0a0a0a';
        ctx.fillStyle = '#0a0a0a';
      } else if (theme === 'retro') {
        gameScreen.style.backgroundColor = '#00aa00';
        ctx.fillStyle = '#001100';
      } else {
        gameScreen.style.backgroundColor = '#000';
        ctx.fillStyle = '#000';
      }
      
      saveUserSettings();
    }

    function setTheme(theme) {
      applyTheme(theme);
      updateThemeButtons();
    }

    function updateThemeButtons() {
      document.getElementById('themeBtn-dark').style.opacity = currentTheme === 'dark' ? '1' : '0.5';
      document.getElementById('themeBtn-neon').style.opacity = currentTheme === 'neon' ? '1' : '0.5';
      document.getElementById('themeBtn-retro').style.opacity = currentTheme === 'retro' ? '1' : '0.5';
    }

    function setPaddleColor(color) {
      paddleColor = color;
      saveUserSettings();
    }

    function setBallStyle(style) {
      ballStyle = style;
      saveUserSettings();
    }

    function toggleSound() {
      soundEnabled = !soundEnabled;
      const btn = document.getElementById('soundBtn');
      btn.textContent = soundEnabled ? 'üîä SOUND ON' : 'üîá SOUND OFF';
      saveUserSettings();
    }

    function playSound(type) {
      if (!soundEnabled) return;
      // Use Web Audio API for simple beeps
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        if (type === 'bounce' || type === 'paddle') {
          oscillator.frequency.value = 600;
          gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.1);
        } else if (type === 'score') {
          oscillator.frequency.value = 800;
          gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.2);
        } else if (type === 'powerup') {
          oscillator.frequency.value = 1000;
          gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.15);
        }
      } catch (e) {
        // Audio not available
      }
    }

    // Draw center line
    function drawLine() {
      ctx.strokeStyle = currentTheme === 'retro' ? '#00ff00' : '#fff';
      if (currentTheme === 'neon') {
        ctx.shadowColor = '#00ff00';
        ctx.shadowBlur = 10;
      }
      ctx.setLineDash([5, 5]);
      ctx.beginPath();
      ctx.moveTo(canvas.width / 2, 0);
      ctx.lineTo(canvas.width / 2, canvas.height);
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.shadowBlur = 0;
    }

    // Update scores
    function updateScores() {
      document.getElementById('score1').textContent = player1.score;
      document.getElementById('score2').textContent = player2.score;
      document.getElementById('p1Streak').textContent = `Streak: ${currentStreak.player1}`;
      document.getElementById('p2Streak').textContent = `Streak: ${currentStreak.player2}`;

      if (gameType === 'classic' || gameType === 'powerups') {
        if (player1.score >= WINNING_SCORE) {
          endGame('Player 1');
        } else if (player2.score >= WINNING_SCORE) {
          endGame('Player 2');
        }
      }

      // Progressive difficulty
      if (progressiveDifficulty && (gameType === 'classic' || gameType === 'powerups')) {
        let speedIncrease = ballRallies * 0.1;
        ball.speedX = ball.baseSpeedX * (ball.speedX > 0 ? 1 : -1) * (1 + speedIncrease);
        ball.speedY = ball.baseSpeedY * (ball.speedY > 0 ? 1 : -1) * (1 + speedIncrease);
      }
    }

    // Game loop
    function gameLoop() {
      if (!isPaused && gameRunning) {
        player1.update();
        if (gameMode === 2) {
          player2.update();
        } else {
          updateAI();
          player2.update();
        }

        if (testMode_playing) {
          ball.speedX = testMode_ballSpeed * (ball.speedX > 0 ? 1 : -1);
          ball.speedY = testMode_ballSpeed * (ball.speedY > 0 ? 1 : -1);
        }

        ball.update();

        if (gameType === 'powerups') {
          spawnPowerUp();
          updatePowerUps();
          updateActivePowerUps();
        }

        updateParticles();

        // Draw
        if (currentTheme === 'retro') {
          ctx.fillStyle = '#001100';
        } else if (currentTheme === 'neon') {
          ctx.fillStyle = '#0a0a0a';
        } else {
          ctx.fillStyle = '#000';
        }
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        if (ballStyle === 'trail') {
          for (let i = 0; i < ballTrail.length; i++) {
            ctx.fillStyle = `rgba(255, 255, 255, ${i / ballTrail.length * 0.5})`;
            ctx.beginPath();
            ctx.arc(ballTrail[i].x, ballTrail[i].y, ball.radius, 0, Math.PI * 2);
            ctx.fill();
          }
        }

        drawLine();
        player1.draw();
        player2.draw();
        ball.draw();

        // Draw particles
        for (let p of particles) {
          p.draw();
        }
      }
      requestAnimationFrame(gameLoop);
    }

    function updateParticles() {
      for (let i = particles.length - 1; i >= 0; i--) {
        particles[i].update();
        if (particles[i].life <= 0) {
          particles.splice(i, 1);
        }
      }
    }

    // End game and update stats
    function endGame(winner) {
      gameRunning = false;
      
      let winner1 = winner === 'Player 1';
      let resultTitle = document.getElementById('resultTitle');
      let resultMessage = document.getElementById('resultMessage');
      let resultStats = document.getElementById('resultStats');

      if (gameMode === 1) {
        if (winner1) {
          resultTitle.textContent = 'üéâ YOU WIN! üéâ';
          resultMessage.textContent = `You defeated the AI!`;
        } else {
          resultTitle.textContent = 'üíÄ YOU LOST üíÄ';
          resultMessage.textContent = `The AI beat you!`;
        }
        
        if (currentUser) {
          if (!userStats[currentUser]) {
            userStats[currentUser] = { wins: 0, losses: 0, bestScore: 0 };
          }
          if (winner1) {
            userStats[currentUser].wins++;
            resultStats.textContent = `Total Wins: ${userStats[currentUser].wins}`;
          } else {
            userStats[currentUser].losses++;
            resultStats.textContent = `Total Losses: ${userStats[currentUser].losses}`;
          }
          const bestScore = Math.max(player1.score, player2.score);
          if (!userStats[currentUser].bestScore || bestScore > userStats[currentUser].bestScore) {
            userStats[currentUser].bestScore = bestScore;
          }
          localStorage.setItem('pongStats', JSON.stringify(userStats));
          
          // Save match history
          if (!matchHistory[currentUser]) matchHistory[currentUser] = [];
          matchHistory[currentUser].push({
            date: new Date().toLocaleString(),
            gameType: gameType,
            result: winner1 ? 'Win' : 'Loss',
            score: `${player1.score}-${player2.score}`
          });
          localStorage.setItem('pongHistory', JSON.stringify(matchHistory));
        }
      } else {
        if (winner1) {
          resultTitle.textContent = 'üéâ PLAYER 1 WINS! üéâ';
          resultMessage.textContent = `Final Score: ${player1.score} - ${player2.score}`;
        } else {
          resultTitle.textContent = 'üéâ PLAYER 2 WINS! üéâ';
          resultMessage.textContent = `Final Score: ${player2.score} - ${player1.score}`;
        }
        resultStats.textContent = 'Game Over!';
      }
      
      document.getElementById('gameScreen').classList.remove('active');
      document.getElementById('resultScreen').classList.add('active');
    }

    // Play again with same settings
    function playAgain() {
      if (lastGameMode === 1) {
        startGameWithDifficulty(lastDifficulty);
      } else if (lastGameType === 'timeattack' || lastGameType === 'survival' || lastGameType === 'powerups') {
        startGameWithType(lastGameType, lastGameMode);
      } else {
        startGame(2);
      }
      document.getElementById('resultScreen').classList.remove('active');
    }

    // Game type selection
    function selectGameMode(mode) {
      gameType = mode;
      lastGameType = mode;
      
      if (mode === 'timeattack' || mode === 'survival' || mode === 'powerups') {
        startGameWithType(mode, 2);
      } else {
        document.getElementById('gameModeScreen').classList.remove('active');
        document.getElementById('difficultyScreen').classList.add('active');
      }
    }

    function startGameWithType(type, players) {
      gameType = type;
      gameMode = players;
      lastGameMode = players;
      lastGameType = type;
      gameRunning = true;
      isPaused = false;
      player1.score = 0;
      player2.score = 0;
      player1.reset();
      player2.reset();
      ball.reset();
      powerUps = [];
      ballRallies = 0;
      currentStreak = { player1: 0, player2: 0 };

      document.getElementById('gameModeScreen').classList.remove('active');
      document.getElementById('difficultyScreen').classList.remove('active');
      document.getElementById('resultScreen').classList.remove('active');
      document.getElementById('gameScreen').classList.add('active');

      if (type === 'timeattack') {
        timeAttackSeconds = 120;
        document.getElementById('gameTimerDisplay').style.display = 'block';
        
        clearInterval(timeAttackInterval);
        timeAttackInterval = setInterval(() => {
          timeAttackSeconds--;
          document.getElementById('gameTimer').textContent = timeAttackSeconds + 's';
          
          if (timeAttackSeconds <= 0) {
            clearInterval(timeAttackInterval);
            let winner = player1.score > player2.score ? 'Player 1' : 'Player 2';
            endGame(winner);
          }
        }, 1000);
      } else {
        document.getElementById('gameTimerDisplay').style.display = 'none';
        clearInterval(timeAttackInterval);
      }

      updateScores();
    }

    // Menu functions
    function startGame(players) {
      if (players === 1) {
        document.getElementById('menuScreen').classList.remove('active');
        document.getElementById('gameModeScreen').classList.add('active');
      } else {
        gameType = 'classic';
        lastGameType = 'classic';
        gameMode = 2;
        lastGameMode = 2;
        gameRunning = true;
        isPaused = false;
        player1.score = 0;
        player2.score = 0;
        player1.reset();
        player2.reset();
        ball.reset();
        ballRallies = 0;
        currentStreak = { player1: 0, player2: 0 };

        const p2Text = document.getElementById('p2Text');
        const p1ControlText = document.getElementById('p1ControlText');
        const mobileControls = document.getElementById('mobileControls');

        if (isMobile) {
          p1ControlText.innerHTML = '<strong>Player 1:</strong> Touch Left Side';
          p2Text.innerHTML = '<strong>Player 2:</strong> Touch Right Side';
          p2Text.style.display = 'block';
          mobileControls.style.display = 'block';
        } else {
          p1ControlText.innerHTML = '<strong>Player 1:</strong> W / S keys';
          p2Text.innerHTML = '<strong>Player 2:</strong> ‚Üë / ‚Üì keys';
          p2Text.style.display = 'block';
          mobileControls.style.display = 'none';
        }

        document.getElementById('menuScreen').classList.remove('active');
        document.getElementById('resultScreen').classList.remove('active');
        document.getElementById('gameScreen').classList.add('active');
        document.getElementById('gameTimerDisplay').style.display = 'none';
        updateScores();
      }
    }

    function startGameWithDifficulty(diff) {
      difficulty = diff;
      lastDifficulty = diff;
      gameType = 'classic';
      lastGameType = 'classic';
      gameMode = 1;
      lastGameMode = 1;
      gameRunning = true;
      isPaused = false;
      player1.score = 0;
      player2.score = 0;
      player1.reset();
      player2.reset();
      ball.reset();
      ballRallies = 0;
      currentStreak = { player1: 0, player2: 0 };

      const p2Text = document.getElementById('p2Text');
      const p1ControlText = document.getElementById('p1ControlText');
      const mobileControls = document.getElementById('mobileControls');

      if (isMobile) {
        p1ControlText.innerHTML = '<strong>Player 1:</strong> Touch Controls';
        p2Text.style.display = 'none';
        mobileControls.style.display = 'block';
      } else {
        p2Text.style.display = 'none';
        mobileControls.style.display = 'none';
      }

      document.getElementById('gameModeScreen').classList.remove('active');
      document.getElementById('difficultyScreen').classList.remove('active');
      document.getElementById('resultScreen').classList.remove('active');
      document.getElementById('gameScreen').classList.add('active');
      document.getElementById('gameTimerDisplay').style.display = 'none';
      updateScores();
    }

    function pauseGame() {
      isPaused = !isPaused;
      const btn = event.target;
      btn.textContent = isPaused ? 'RESUME' : 'PAUSE';
    }

    function unstuckBall() {
      ball.x = canvas.width / 2;
      ball.y = canvas.height / 2;
      
      const direction = Math.random() > 0.5 ? 1 : -1;
      ball.speedX = 4 * direction;
      ball.speedY = (Math.random() * 4 - 2);
    }

    // Customization functions
    function enterCustomization() {
      document.getElementById('menuScreen').classList.remove('active');
      document.getElementById('customizationScreen').classList.add('active');
      updateThemeButtons();
      updateSoundButton();
    }

    function updateSoundButton() {
      const btn = document.getElementById('soundBtn');
      btn.textContent = soundEnabled ? 'üîä SOUND ON' : 'üîá SOUND OFF';
    }

    // Profile functions
    function viewProfile() {
      if (!currentUser) return;
      
      const stats = userStats[currentUser] || { wins: 0, losses: 0, bestScore: 0 };
      const games = (stats.wins || 0) + (stats.losses || 0);
      const winRate = games > 0 ? ((stats.wins / games) * 100).toFixed(1) : 0;

      document.getElementById('profileUsername').textContent = currentUser;
      document.getElementById('profileWins').textContent = stats.wins || 0;
      document.getElementById('profileLosses').textContent = stats.losses || 0;
      document.getElementById('profileWinRate').textContent = winRate;
      document.getElementById('profileGames').textContent = games;
      document.getElementById('profileBest').textContent = stats.bestScore || 0;

      const historyList = document.getElementById('matchHistoryList');
      historyList.innerHTML = '';
      
      const history = matchHistory[currentUser] || [];
      const recentMatches = history.slice(-10).reverse();
      
      if (recentMatches.length === 0) {
        historyList.innerHTML = '<p style="text-align: center; color: #999;">No matches yet</p>';
      } else {
        recentMatches.forEach(match => {
          const item = document.createElement('div');
          item.className = 'history-item';
          item.style.padding = '10px';
          item.style.margin = '5px 0';
          item.style.backgroundColor = match.result === 'Win' ? 'rgba(0, 255, 0, 0.1)' : 'rgba(255, 0, 0, 0.1)';
          item.style.borderRadius = '5px';
          item.style.fontSize = '14px';
          item.innerHTML = `
            <strong>${match.result}</strong> | ${match.gameType} | Score: ${match.score}<br>
            <span style="color: #999; font-size: 12px;">${match.date}</span>
          `;
          historyList.appendChild(item);
        });
      }

      document.getElementById('menuScreen').classList.remove('active');
      document.getElementById('profileScreen').classList.add('active');
    }

    // Owner Button Logic
    function titleClicked() {
      titleClickCount++;
      clearTimeout(titleClickTimer);

      if (titleClickCount === 7) {
        document.getElementById('ownerBtn').style.display = 'block';
        titleClickCount = 0;
      }

      titleClickTimer = setTimeout(() => {
        titleClickCount = 0;
      }, 2000);
    }

    // Test Mode Functions
    function enterTestMode() {
      testModeActive = true;
      document.getElementById('menuScreen').classList.remove('active');
      document.getElementById('testScreen').classList.add('active');
      updateTestDisplay();
    }

    function testBallSpeed() {
      const slider = document.getElementById('ballSpeedSlider');
      testMode_ballSpeed = parseInt(slider.value);
      ball.speedX = testMode_ballSpeed;
      ball.speedY = testMode_ballSpeed;
      document.getElementById('ballSpeedDisplay').textContent = 'Current: ' + testMode_ballSpeed;
    }

    function testAIDifficulty(diff) {
      difficulty = diff;
      document.getElementById('aiDiffDisplay').textContent = 'Current: ' + diff;
    }

    function testPaddleSize() {
      const slider = document.getElementById('paddleSizeSlider');
      const newSize = parseInt(slider.value);
      player1.height = newSize;
      player2.height = newSize;
      document.getElementById('paddleSizeDisplay').textContent = 'Current: ' + newSize + 'px';
    }

    function testCanvasSize(width, height) {
      canvas.width = width;
      canvas.height = height;
      document.getElementById('canvasSizeDisplay').textContent = 'Current: ' + width + 'x' + height;
    }

    function testResetScores() {
      player1.score = 0;
      player2.score = 0;
      document.getElementById('statsDisplay').textContent = 'P1: 0 | P2: 0';
      updateScores();
    }

    function testSetScore() {
      const p1Score = prompt('Enter Player 1 score:', player1.score);
      if (p1Score !== null) {
        player1.score = parseInt(p1Score) || 0;
      }
      const p2Score = prompt('Enter Player 2 score:', player2.score);
      if (p2Score !== null) {
        player2.score = parseInt(p2Score) || 0;
      }
      document.getElementById('statsDisplay').textContent = 'P1: ' + player1.score + ' | P2: ' + player2.score;
      updateScores();
    }

    function updateTestDisplay() {
      document.getElementById('ballSpeedDisplay').textContent = 'Current: ' + testMode_ballSpeed;
      document.getElementById('aiDiffDisplay').textContent = 'Current: ' + difficulty;
      document.getElementById('paddleSizeDisplay').textContent = 'Current: ' + player1.height + 'px';
      document.getElementById('canvasSizeDisplay').textContent = 'Current: ' + canvas.width + 'x' + canvas.height;
      document.getElementById('statsDisplay').textContent = 'P1: ' + player1.score + ' | P2: ' + player2.score;
    }

    function startTestGame(players) {
      gameMode = players;
      gameRunning = true;
      isPaused = false;
      testMode_playing = true;
      gameType = 'classic';
      player1.score = 0;
      player2.score = 0;
      player1.reset();
      player2.reset();
      ball.reset();

      const p2Text = document.getElementById('p2Text');
      const p1ControlText = document.getElementById('p1ControlText');
      const mobileControls = document.getElementById('mobileControls');

      if (isMobile) {
        p1ControlText.innerHTML = '<strong>Player 1:</strong> Touch Left Side';
        if (players === 2) {
          p2Text.innerHTML = '<strong>Player 2:</strong> Touch Right Side';
          p2Text.style.display = 'block';
        } else {
          p2Text.style.display = 'none';
        }
        mobileControls.style.display = 'block';
      } else {
        p1ControlText.innerHTML = '<strong>Player 1:</strong> W / S keys';
        if (players === 2) {
          p2Text.innerHTML = '<strong>Player 2:</strong> ‚Üë / ‚Üì keys';
          p2Text.style.display = 'block';
        } else {
          p2Text.style.display = 'none';
        }
        mobileControls.style.display = 'none';
      }

      document.getElementById('testScreen').classList.remove('active');
      document.getElementById('gameScreen').classList.add('active');
      updateScores();
    }

    function goToMenu() {
      gameRunning = false;
      isPaused = false;
      testModeActive = false;
      testMode_playing = false;
      clearInterval(timeAttackInterval);
      
      document.getElementById('gameScreen').classList.remove('active');
      document.getElementById('gameModeScreen').classList.remove('active');
      document.getElementById('difficultyScreen').classList.remove('active');
      document.getElementById('testScreen').classList.remove('active');
      document.getElementById('resultScreen').classList.remove('active');
      document.getElementById('customizationScreen').classList.remove('active');
      document.getElementById('profileScreen').classList.remove('active');
      document.getElementById('ranklistScreen').classList.remove('active');
      document.getElementById('menuScreen').classList.add('active');
      
      const btn = document.querySelector('[onclick="pauseGame()"]');
      if (btn) btn.textContent = 'PAUSE';
    }

    // Start game loop
    gameLoop();

    // Authentication Functions
    function loginUser() {
      const username = document.getElementById('usernameInput').value.trim();
      const password = document.getElementById('passwordInput').value;
      const errorMsg = document.getElementById('loginError');
      
      errorMsg.textContent = '';
      
      if (!username || !password) {
        errorMsg.textContent = 'Please enter username and password';
        return;
      }
      
      if (!users[username] || users[username] !== password) {
        errorMsg.textContent = 'Invalid username or password';
        return;
      }
      
      currentUser = username;
      loadUserSettings();
      if (username === OWNER_USERNAME) {
        document.getElementById('ownerBtn').style.display = 'block';
      }
      
      document.getElementById('loginScreen').classList.remove('active');
      document.getElementById('menuScreen').classList.add('active');
    }

    function registerUser() {
      const username = document.getElementById('regUsernameInput').value.trim();
      const password = document.getElementById('regPasswordInput').value;
      const confirm = document.getElementById('regPasswordConfirm').value;
      const errorMsg = document.getElementById('registerError');
      
      errorMsg.textContent = '';
      
      if (!username || !password || !confirm) {
        errorMsg.textContent = 'Please fill all fields';
        return;
      }
      
      if (username.length < 3) {
        errorMsg.textContent = 'Username must be at least 3 characters';
        return;
      }
      
      if (password.length < 4) {
        errorMsg.textContent = 'Password must be at least 4 characters';
        return;
      }
      
      if (password !== confirm) {
        errorMsg.textContent = 'Passwords do not match';
        return;
      }
      
      if (users[username]) {
        errorMsg.textContent = 'Username already exists';
        return;
      }
      
      users[username] = password;
      userStats[username] = { wins: 0, losses: 0, bestScore: 0 };
      matchHistory[username] = [];
      localStorage.setItem('pongUsers', JSON.stringify(users));
      localStorage.setItem('pongStats', JSON.stringify(userStats));
      localStorage.setItem('pongHistory', JSON.stringify(matchHistory));
      
      document.getElementById('regUsernameInput').value = '';
      document.getElementById('regPasswordInput').value = '';
      document.getElementById('regPasswordConfirm').value = '';
      
      switchToLogin();
      document.getElementById('loginError').textContent = 'Registration successful! Please login.';
    }

    function switchToRegister() {
      document.querySelector('.login-form').style.display = 'none';
      document.getElementById('registerForm').style.display = 'block';
    }

    function switchToLogin() {
      document.querySelector('.login-form').style.display = 'block';
      document.getElementById('registerForm').style.display = 'none';
    }

    function logoutUser() {
      currentUser = null;
      document.getElementById('ownerBtn').style.display = 'none';
      document.getElementById('menuScreen').classList.remove('active');
      document.getElementById('loginScreen').classList.add('active');
      document.getElementById('usernameInput').value = '';
      document.getElementById('passwordInput').value = '';
      document.getElementById('loginError').textContent = '';
    }

    function viewRanklist() {
      const ranklistBody = document.getElementById('ranklistBody');
      ranklistBody.innerHTML = '';
      
      const sorted = Object.entries(userStats)
        .map(([username, stats]) => ({
          username,
          wins: stats.wins || 0,
          losses: stats.losses || 0,
          winRate: stats.wins + stats.losses > 0 ? ((stats.wins / (stats.wins + stats.losses)) * 100).toFixed(1) : 0
        }))
        .sort((a, b) => {
          if (b.wins !== a.wins) return b.wins - a.wins;
          return a.losses - b.losses;
        });
      
      sorted.forEach((user, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>#${index + 1}</td>
          <td>${user.username}</td>
          <td>${user.wins}</td>
          <td>${user.losses}</td>
          <td>${user.winRate}%</td>
        `;
        ranklistBody.appendChild(row);
      });
      
      document.getElementById('menuScreen').classList.remove('active');
      document.getElementById('ranklistScreen').classList.add('active');
    }

    // Initialize app
    if (!currentUser) {
      document.getElementById('menuScreen').classList.remove('active');
      document.getElementById('loginScreen').classList.add('active');
    } else {
      loadUserSettings();
    }
  </script>
</body>

</html>